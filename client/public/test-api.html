<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ„è§åé¦ˆ API æµ‹è¯•</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    h1 {
      color: #333;
      margin-bottom: 20px;
    }
    .section {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .section h2 {
      font-size: 18px;
      color: #333;
      margin-bottom: 15px;
    }
    .info-item {
      margin-bottom: 10px;
    }
    .info-label {
      font-weight: bold;
      color: #666;
      margin-right: 10px;
    }
    .info-value {
      color: #333;
      font-family: 'Courier New', monospace;
    }
    .info-value.error {
      color: #e74c3c;
    }
    .info-value.success {
      color: #27ae60;
    }
    button {
      background-color: #007AFF;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #0056b3;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      resize: vertical;
      min-height: 200px;
    }
    .log-entry {
      padding: 5px 0;
      border-bottom: 1px solid #eee;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }
    .log-entry.error {
      color: #e74c3c;
    }
    .log-entry.success {
      color: #27ae60;
    }
    .log-entry.info {
      color: #3498db;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ§ª æ„è§åé¦ˆ API æµ‹è¯•å·¥å…·</h1>

    <!-- ç¯å¢ƒä¿¡æ¯ -->
    <div class="section">
      <h2>ğŸ“Š ç¯å¢ƒä¿¡æ¯</h2>
      <div class="info-item">
        <span class="info-label">API Base URL:</span>
        <span class="info-value" id="apiBaseUrl">æ£€æµ‹ä¸­...</span>
      </div>
      <div class="info-item">
        <span class="info-label">å®Œæ•´åé¦ˆ API URL:</span>
        <span class="info-value" id="fullApiUrl">æ£€æµ‹ä¸­...</span>
      </div>
      <div class="info-item">
        <span class="info-label">å½“å‰æ—¶é—´:</span>
        <span class="info-value" id="currentTime"></span>
      </div>
    </div>

    <!-- æ­¥éª¤1: æµ‹è¯•å¥åº·æ£€æŸ¥ -->
    <div class="section">
      <h2>æ­¥éª¤ 1: æµ‹è¯•å¥åº·æ£€æŸ¥</h2>
      <button onclick="testHealthCheck()" id="healthCheckBtn">æµ‹è¯•è¿æ¥</button>
      <div id="healthCheckResult" style="margin-top: 10px;"></div>
    </div>

    <!-- æ­¥éª¤2: è·å–ç”¨æˆ·åˆ—è¡¨ -->
    <div class="section">
      <h2>æ­¥éª¤ 2: è·å–ç”¨æˆ·åˆ—è¡¨</h2>
      <button onclick="getUsers()" id="getUsersBtn" disabled>è·å–ç”¨æˆ·</button>
      <div id="usersResult" style="margin-top: 10px;"></div>
      <div id="selectedUser" style="margin-top: 10px;"></div>
    </div>

    <!-- æ­¥éª¤3: æäº¤åé¦ˆ -->
    <div class="section">
      <h2>æ­¥éª¤ 3: æäº¤åé¦ˆ</h2>
      <button onclick="submitFeedback()" id="submitBtn" disabled>æäº¤åé¦ˆ</button>
      <div id="submitResult" style="margin-top: 10px;"></div>
    </div>

    <!-- å®Œæ•´æ—¥å¿— -->
    <div class="section">
      <h2>ğŸ“ å®Œæ•´æ—¥å¿—</h2>
      <textarea id="logArea" readonly></textarea>
    </div>
  </div>

  <script>
    let API_BASE_URL = '';
    let selectedUserId = null;

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      updateEnvInfo();
      log('âœ… é¡µé¢å·²åŠ è½½', 'success');
      log('ğŸ” æ£€æµ‹ç¯å¢ƒå˜é‡...', 'info');

      // å°è¯•ä» window å¯¹è±¡è·å–ç¯å¢ƒå˜é‡ï¼ˆExpo Web ä¼šæ³¨å…¥åˆ° window.expoConfigï¼‰
      if (window.expoConfig && window.expoConfig.extra) {
        API_BASE_URL = window.expoConfig.extra.EXPO_PUBLIC_BACKEND_BASE_URL;
      }

      // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°è¯•å…¨å±€å˜é‡
      if (!API_BASE_URL && window.EXPO_PUBLIC_BACKEND_BASE_URL) {
        API_BASE_URL = window.EXPO_PUBLIC_BACKEND_BASE_URL;
      }

      if (API_BASE_URL) {
        document.getElementById('apiBaseUrl').textContent = API_BASE_URL;
        document.getElementById('apiBaseUrl').classList.add('success');
        document.getElementById('fullApiUrl').textContent = `${API_BASE_URL}/api/v1/feedbacks`;
        log(`âœ… ç¯å¢ƒå˜é‡å·²åŠ è½½: ${API_BASE_URL}`, 'success');
      } else {
        document.getElementById('apiBaseUrl').textContent = 'âŒ æœªæ‰¾åˆ°ç¯å¢ƒå˜é‡';
        document.getElementById('apiBaseUrl').classList.add('error');
        document.getElementById('fullApiUrl').textContent = 'N/A';
        log('âŒ æœªæ‰¾åˆ°ç¯å¢ƒå˜é‡ï¼Œå°†ä½¿ç”¨é»˜è®¤å€¼', 'error');
        API_BASE_URL = 'http://localhost:9091';
        document.getElementById('apiBaseUrl').textContent = `${API_BASE_URL} (é»˜è®¤å€¼)`;
        document.getElementById('apiBaseUrl').classList.add('success');
        document.getElementById('fullApiUrl').textContent = `${API_BASE_URL}/api/v1/feedbacks`;
      }

      updateCurrentTime();
      setInterval(updateCurrentTime, 1000);
    });

    function updateEnvInfo() {
      // æ£€æŸ¥æ‰€æœ‰å¯èƒ½çš„ç¯å¢ƒå˜é‡ä½ç½®
      log('=== ç¯å¢ƒå˜é‡æ£€æµ‹ ===', 'info');

      if (window.process && window.process.env) {
        log(`window.process.env.EXPO_PUBLIC_BACKEND_BASE_URL: ${window.process.env.EXPO_PUBLIC_BACKEND_BASE_URL || 'undefined'}`, 'info');
      }

      if (window.expoConfig) {
        log(`window.expoConfig: ${JSON.stringify(window.expoConfig, null, 2)}`, 'info');
      }

      if (window.EXPO_PUBLIC_BACKEND_BASE_URL) {
        log(`window.EXPO_PUBLIC_BACKEND_BASE_URL: ${window.EXPO_PUBLIC_BACKEND_BASE_URL}`, 'info');
      }

      log('=== æ£€æµ‹å®Œæˆ ===', 'info');
    }

    function updateCurrentTime() {
      document.getElementById('currentTime').textContent = new Date().toLocaleString();
    }

    function log(message, type = 'info') {
      const logArea = document.getElementById('logArea');
      const timestamp = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `[${timestamp}] ${message}`;
      logArea.appendChild(entry);
      logArea.scrollTop = logArea.scrollHeight;
      console.log(`[${type.toUpperCase()}] ${message}`);
    }

    async function testHealthCheck() {
      const btn = document.getElementById('healthCheckBtn');
      const resultDiv = document.getElementById('healthCheckResult');

      btn.disabled = true;
      btn.textContent = 'æµ‹è¯•ä¸­...';
      resultDiv.innerHTML = '';

      log(`ğŸ“¡ å‘é€å¥åº·æ£€æŸ¥è¯·æ±‚åˆ°: ${API_BASE_URL}/api/v1/health`, 'info');

      try {
        const response = await fetch(`${API_BASE_URL}/api/v1/health`);
        const data = await response.json();

        log(`âœ… å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`, 'info');
        log(`ğŸ“¦ å“åº”æ•°æ®: ${JSON.stringify(data)}`, 'info');

        if (response.ok) {
          resultDiv.innerHTML = `<span class="info-value success">âœ… è¿æ¥æˆåŠŸï¼çŠ¶æ€ç : ${response.status}</span>`;
          log('âœ… å¥åº·æ£€æŸ¥é€šè¿‡', 'success');
          document.getElementById('getUsersBtn').disabled = false;
        } else {
          resultDiv.innerHTML = `<span class="info-value error">âŒ è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : ${response.status}</span>`;
          log('âŒ å¥åº·æ£€æŸ¥å¤±è´¥', 'error');
        }
      } catch (error) {
        resultDiv.innerHTML = `<span class="info-value error">âŒ ç½‘ç»œé”™è¯¯: ${error.message}</span>`;
        log(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
        console.error(error);
      } finally {
        btn.disabled = false;
        btn.textContent = 'æµ‹è¯•è¿æ¥';
      }
    }

    async function getUsers() {
      const btn = document.getElementById('getUsersBtn');
      const resultDiv = document.getElementById('usersResult');

      btn.disabled = true;
      btn.textContent = 'è·å–ä¸­...';
      resultDiv.innerHTML = '';

      log(`ğŸ‘¥ è·å–ç”¨æˆ·åˆ—è¡¨...`, 'info');

      try {
        const response = await fetch(`${API_BASE_URL}/api/v1/users`);
        const data = await response.json();

        log(`âœ… å“åº”çŠ¶æ€: ${response.status}`, 'info');
        log(`ğŸ“¦ ç”¨æˆ·æ•°æ®: ${JSON.stringify(data)}`, 'info');

        if (response.ok && data.success && data.data && data.data.length > 0) {
          const user = data.data[0];
          selectedUserId = user.id;
          resultDiv.innerHTML = `<span class="info-value success">âœ… æ‰¾åˆ° ${data.data.length} ä¸ªç”¨æˆ·</span>`;
          document.getElementById('selectedUser').innerHTML = `
            <span class="info-label">é€‰æ‹©ç”¨æˆ·:</span>
            <span class="info-value">${user.name} (${user.nickname}) - ID: ${user.id}</span>
          `;
          log(`âœ… é€‰æ‹©ç”¨æˆ·: ${user.name} (ID: ${user.id})`, 'success');
          document.getElementById('submitBtn').disabled = false;
        } else {
          resultDiv.innerHTML = `<span class="info-value error">âŒ è·å–ç”¨æˆ·å¤±è´¥</span>`;
          log('âŒ è·å–ç”¨æˆ·å¤±è´¥', 'error');
        }
      } catch (error) {
        resultDiv.innerHTML = `<span class="info-value error">âŒ ç½‘ç»œé”™è¯¯: ${error.message}</span>`;
        log(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
        console.error(error);
      } finally {
        btn.disabled = false;
        btn.textContent = 'è·å–ç”¨æˆ·';
      }
    }

    async function submitFeedback() {
      const btn = document.getElementById('submitBtn');
      const resultDiv = document.getElementById('submitResult');

      btn.disabled = true;
      btn.textContent = 'æäº¤ä¸­...';
      resultDiv.innerHTML = '';

      const feedbackData = {
        user_id: selectedUserId,
        content: `ç½‘é¡µæµ‹è¯•åé¦ˆ - ${new Date().toISOString()}`,
        contact: 'web-test@example.com'
      };

      log(`ğŸ“ æäº¤åé¦ˆæ•°æ®: ${JSON.stringify(feedbackData)}`, 'info');

      try {
        const response = await fetch(`${API_BASE_URL}/api/v1/feedbacks`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(feedbackData),
        });

        const data = await response.json();

        log(`âœ… å“åº”çŠ¶æ€: ${response.status}`, 'info');
        log(`ğŸ“¦ å“åº”æ•°æ®: ${JSON.stringify(data)}`, 'info');

        if (response.ok && (data.success || data.data)) {
          resultDiv.innerHTML = `
            <div>
              <span class="info-value success">âœ… æäº¤æˆåŠŸï¼</span><br>
              <span class="info-value">åé¦ˆ ID: ${data.data.id}</span>
            </div>
          `;
          log(`âœ… åé¦ˆæäº¤æˆåŠŸï¼ID: ${data.data.id}`, 'success');
        } else {
          resultDiv.innerHTML = `<span class="info-value error">âŒ æäº¤å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}</span>`;
          log('âŒ åé¦ˆæäº¤å¤±è´¥', 'error');
        }
      } catch (error) {
        resultDiv.innerHTML = `<span class="info-value error">âŒ ç½‘ç»œé”™è¯¯: ${error.message}</span>`;
        log(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
        console.error(error);
      } finally {
        btn.disabled = false;
        btn.textContent = 'æäº¤åé¦ˆ';
      }
    }
  </script>
</body>
</html>
